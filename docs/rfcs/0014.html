<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js dark">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>0014 - the-darwinia-book</title>
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "dark";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('dark')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div id="sidebar-scrollbox" class="sidebar-scrollbox">
                <ol class="chapter"><li class="expanded affix "><a href="../index.html">Introduction</a></li><li class="spacer"></li><li class="expanded "><a href="../concepts/index.html"><strong aria-hidden="true">1.</strong> Concepts</a></li><li><ol class="section"><li class="expanded "><a href="../concepts/balances.html"><strong aria-hidden="true">1.1.</strong> Balances</a></li><li class="expanded "><a href="../concepts/election.html"><strong aria-hidden="true">1.2.</strong> Election</a></li><li class="expanded "><a href="../concepts/relay_chain.html"><strong aria-hidden="true">1.3.</strong> Relay Chain</a></li><li class="expanded "><a href="../concepts/staking.html"><strong aria-hidden="true">1.4.</strong> Staking</a></li><li class="expanded "><a href="../concepts/treasury.html"><strong aria-hidden="true">1.5.</strong> Treasury</a></li></ol></li><li class="expanded "><a href="../source/index.html"><strong aria-hidden="true">2.</strong> Source Code Trip</a></li><li><ol class="section"><li class="expanded "><a href="../source/bin.html"><strong aria-hidden="true">2.1.</strong> bin</a></li><li class="expanded "><a href="../source/client.html"><strong aria-hidden="true">2.2.</strong> client</a></li><li class="expanded "><a href="../source/frame/index.html"><strong aria-hidden="true">2.3.</strong> frame</a></li><li><ol class="section"><li class="expanded "><a href="../source/frame/balances.html"><strong aria-hidden="true">2.3.1.</strong> balances</a></li><li class="expanded "><a href="../source/frame/chainrelay.html"><strong aria-hidden="true">2.3.2.</strong> chainrelay</a></li><li class="expanded "><a href="../source/frame/elections_phragmen.html"><strong aria-hidden="true">2.3.3.</strong> elections-phragmen</a></li><li class="expanded "><a href="../source/frame/staking.html"><strong aria-hidden="true">2.3.4.</strong> staking</a></li><li class="expanded "><a href="../source/frame/support.html"><strong aria-hidden="true">2.3.5.</strong> support</a></li><li class="expanded "><a href="../source/frame/treasury.html"><strong aria-hidden="true">2.3.6.</strong> treasury</a></li></ol></li><li class="expanded "><a href="../source/primitives.html"><strong aria-hidden="true">2.4.</strong> primitives</a></li></ol></li><li class="expanded "><a href="../rfcs/index.html"><strong aria-hidden="true">3.</strong> RFCs</a></li><li><ol class="section"><li class="expanded "><a href="../rfcs/0001.html"><strong aria-hidden="true">3.1.</strong> 0001</a></li><li class="expanded "><a href="../rfcs/0007.html"><strong aria-hidden="true">3.2.</strong> 0007</a></li><li class="expanded "><a href="../rfcs/0009.html"><strong aria-hidden="true">3.3.</strong> 0009</a></li><li class="expanded "><a href="../rfcs/0010.html"><strong aria-hidden="true">3.4.</strong> 0010</a></li><li class="expanded "><a href="../rfcs/0011.html"><strong aria-hidden="true">3.5.</strong> 0011</a></li><li class="expanded "><a href="../rfcs/0012.html"><strong aria-hidden="true">3.6.</strong> 0012</a></li><li class="expanded "><a href="../rfcs/0013.html"><strong aria-hidden="true">3.7.</strong> 0013</a></li><li class="expanded "><a href="../rfcs/0014.html" class="active"><strong aria-hidden="true">3.8.</strong> 0014</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">the-darwinia-book</h1>

                        <div class="right-buttons">
                            <a href="../print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                            <a href="https://github.com/darwinia-network/the-darwinia-book" title="Git repository" aria-label="Git repository">
                                <i id="git-repository-button" class="fa fa-github"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#0014" id="0014">0014</a></h1>
<blockquote>
<p>Darwinia Token Migration By Cross-chain Redeem Protocol</p>
</blockquote>
<h2><a class="header" href="#i-概述" id="i-概述">I. 概述</a></h2>
<p>在Darwinia主网上线之前，已经有一部分RING/KTON资产以ERC20或TRC20的形式存在于以太坊网络或者波场网络之中。从资产跨链的角度来看，因为RING和KTON是被定义成Darwinia 网络的原生资产，因此这些ERC20 Token本质上是以某种形式跨链到以太坊网络上的，也可以理解为CBA (Cryptocurreny Backed Assets)，也就是说，每个ERC-20 RING都有相应的RING被锁定在Darwinia 主网上面，在主网上线之前，相应的背书资产即存在于创世块(Genesis)中。</p>
<p>RING和KTON的ERC20 Token信息:</p>
<ul>
<li>RING Token Address: https://etherscan.io/token/0x9469d013805bffb7d3debe5e7839237e535ec483</li>
<li>KTON Token Address: https://etherscan.io/token/0x9f284e1337a815fe77d2ff4ae46544645b20c5ff</li>
</ul>
<p>本文将在<a href="./0012-darwinia-bridge-core-interoperation-in-chainrelay-enabled-blockchains.html">RFC-0012: Darwinia Bridge Core: Interoperation in ChainRelay Enabled Blockchains</a>的基础上，讨论Darwinia主网上线后，ERC-20形式的RING如何赎回至Darwinia网络，以及如何借助于Darwinia 转接桥的设计，Token将如何在Darwinia主网及其他公链中进行流转。</p>
<h2><a class="header" href="#ii-介绍" id="ii-介绍">II. 介绍</a></h2>
<h3><a class="header" href="#a-设计范围" id="a-设计范围">A. 设计范围</a></h3>
<ul>
<li>Darwinia原生资产RING/KTON跨链设计。主要描述如何应用ERC-0012及相关跨链互操作协议，帮助RING/KTON实现在Darwinia网络和其他支持智能合约的网络(例如，以太坊、TRON、EOS)之间流转</li>
<li>创世块中管理背书资产。当Darwinia主网上线时，目前以ERC20/TRC20形式存在的RING/KTON对应的原生资产将会记录在创世块之中，并被背书管理模块锁定，用于支持后续外部资产的赎回。</li>
<li>背书管理模块的其他主要功能。背书管理模块还将满足主网上线后其他的跨链转账需求，例如后续用户如何将主网上的RING/KTON原生资产跨链到以太坊上。其发行出来的ERC20代币(代表CBA)将与现有的RING/KTON合约共享同一个ERC-20智能合约。</li>
<li>外部链的发行合约和chain relay。这部分方案的可行性依赖于chain relay的实现方案，主要是如何在以太坊上实现一个低成本可持续运行的Darwinia Chain Relay，这部分的细节不在此处描述，具体可参考 RFV-0012 VI章节。在以太坊实现了一个Darwinia Chain Relay的基础之上，外部链需要新增一个发型管理合约(Issuing Contract)用于接受Darwinia上的跨链转账交易证明，并通过Darwinia Chain Relay进行验证（包括交易存在证明，共识证明，交易内容证明等），在验证通过之后，进行相关的RING/KTON发行。这部分属于高级功能，其开发和实现可以独立于背书模块中的迁移功能，在最开始，可以先只支持单向的以太坊至Darwinia的赎回功能。</li>
<li>Gringotts合约的停止和存单迁移协议</li>
</ul>
<h3><a class="header" href="#b-术语" id="b-术语">B. 术语</a></h3>
<ul>
<li><strong>Genesis</strong>， 创世块或表示区块链网络创世状态的账本数据。</li>
<li><strong>CBA</strong>, 全称Cryptocurrency Backed Assets, 即有加密资产背书的资产，详细介绍可以参考XClaim <a href="https://github.com/darwinia-network/rfcs/raw/master/RFC/zh_CN/images/darwinia_deposit_migration_protocol.png">1</a>.</li>
<li><strong>Chain Relay</strong>,  Cross-Chain State Verification. It is capable of interpreting the statte of the backing blockchain B and provide functionality comparable to an SPV or light client. 主要用于验证外部区块链网络的交易存在性证明和共识证明。</li>
<li><strong>Backing Contract/Module</strong>，Backing Blockchain中用于管理背书资产的合约或者模块，包括锁定和释放等功能，在Darwinia网络中Backing Module还负责管理锁定在创世块中的背书资产。</li>
<li><strong>Chain Relay Module</strong>, 实现在Darwinia上的针对外部区块链网络(例如Ethereum/ Tron)的Chain Relay.</li>
<li><strong>External Darwinia Chain Relay</strong>，存在于外部区块链网络上的针对Darwinia Network的Chain Relay.</li>
<li><strong>External Issuing Contract</strong>, 用于在外部区块链网络中发行原生RING/KTON CBA的ERC-20 Token.</li>
</ul>
<h3><a class="header" href="#c-背书资产genesis配置" id="c-背书资产genesis配置">C. 背书资产Genesis配置</a></h3>
<p>在Darwinia主网上线之时，就存在CBA背书资产，因此需要将RING/KTON在其他链上的资产背书信息定义在Genesis Config中，当主网上线之后，这些背书资产将会初始化相应原生资产，并将其锁定在背书合约中，供特殊赎回(迁移)协议使用。</p>
<p>需要注意的是，Genesis Config总分发和锁定的RING/KTON，将对应于主网上线时对应公链上RING/KTON的Total Supply. </p>
<p>Genesis Config 片段示例:</p>
<pre><code class="language-json">{
  &quot;backingAssets&quot;: {
    &quot;Ethereum&quot; : {
      &quot;RING&quot; : 100000,
      &quot;KTON&quot; : 50000
    },
    &quot;Tron&quot; : {
      &quot;RING&quot; : 3000,
      &quot;KTON&quot; : 200
    }
  }
}
</code></pre>
<h3><a class="header" href="#iii-通过特殊赎回协议实现ringkton迁移" id="iii-通过特殊赎回协议实现ringkton迁移">III. 通过特殊赎回协议实现RING/KTON迁移</a></h3>
<p>当用户需要将ERC-20形式的RING通证转化成Darwinia主网上的RING的时候，其只需要将该部分RING发送一个Token销毁合约，在确认销毁成功之后，用户将该笔交易证明发送给Darwinia网路的解锁合约，解锁合约在验证完成之后，将会从背书资产模块中释放对应的RING通证给赎回者。</p>
<p><img src="https://github.com/darwinia-network/rfcs/raw/master/RFC/zh_CN/images/darwinia_token_migration_protocol.png" alt="Darwinia Token Migration Protocol" /></p>
<h4><a class="header" href="#a-与普通赎回协议的区别" id="a-与普通赎回协议的区别">A. 与普通赎回协议的区别</a></h4>
<p>RING/KTON特殊赎回协议跟Darwinia Bridge Core中的普通赎回协议最大的区别在于背书资产(Backing Assets)。普通赎回协议中需要赎回的背书资产，都是之前通过发行协议锁定在Backing Contract里面的，但是在RING/KTON特殊赎回协议这里并没有先前的锁定发行CBA的过程，主网上线前的ERC20 RING对应的Backing Assets是通过创始块背书，进行分发和锁定。</p>
<p>创始块中锁定的原生资产用于支持原本已经在其他公链(Ethereum和Tron)上已经存在的ERC20形式的RING/KTON赎回功能。当用户需要拿回Darwinia主链上的原生背书资产时，他们只需要按照特殊赎回协议销毁背书资产对应的RING/KTON CBA Token就可以了。</p>
<h4><a class="header" href="#b-chain-relay-srml模块" id="b-chain-relay-srml模块">B. Chain Relay SRML模块</a></h4>
<p>Chain Relay是实现Token跨链转接桥的关键模块，类似于一个支持SPV的轻客户端。在像以太坊这样的智能合约公链中，Chain Relay是用智能合约来实现的，例如<a href="https://github.com/ethereum/btcrelay">BTCRelay</a>。对于Darwinia来说，因为是基于Substrate开发，支持SRML模块和链上升级，所以就多了一个选择，可以将Chain Relay的实现为Darwinia的一个SRML，并针对不同的公链实现不同的SRML形式的Chain Relay，以提供相应公链的跨链支持。</p>
<p>对于具体的实现，性能和成本是非常重要的考量，因此需要基于一些改进方案来帮助实现，相关改进方案在RFC-0012 VI章节详细描述。</p>
<h4><a class="header" href="#c-gringotts合约的停止和存单迁移协议" id="c-gringotts合约的停止和存单迁移协议">C. Gringotts合约的停止和存单迁移协议</a></h4>
<p>Gringotts合约实现:</p>
<p>https://github.com/evolutionlandorg/bank</p>
<p>Gringotts合约功能中存RING得KTON的功能对应于Darwinia Staking 模块中的承诺锁定得KTON的功能，Darwinia主网上线后，这部分功能将从以太坊(或波场)Gringotts智能合约迁移至Darwinia主网。</p>
<p>为了保证主网上线时和之后，其他公链上不会有新的KTON被通过定期存RING发行出来，因此，主网上线前Gringott合约功能将停止存RING得KTON功能，但是RING取回功能仍将保留。</p>
<p>此外，因为Gringotts存单中锁定了RING，而这部分RING的持有者可能希望参与到Darwinia Staking中去，因此需要支持Gringotts存单迁移的功能，主要包括以下几个步骤(以太坊为例):</p>
<ul>
<li>
<p>将存单以及存单中的RING一起销毁，销毁交易中需要包含存单ID，锁定RING的数量，存单到期时间等关键参数证明，销毁合约将会对这些关键参数进行比对和校验，通过之后销毁存单的RING Token。这样只需要证明交易被打包和存在，就可以从交易中解析出这些关键参数，并保证这些参数的正确性。</p>
</li>
<li>
<p>迁移者在确定这笔交易的成功和Finalization之后，将这个交易证明提交给Darwinia的存单迁移模块。</p>
</li>
<li>
<p>Darwinia的存单迁移模块在验证交易的正确性之后，将进行Darwinia上的剩余迁移步骤，包括a)对应数量RING的解锁，b)将这些RING进行Staking. c) 对这些Staking的RING进行承诺锁定.(区别于正常流程，这里不会有KTON奖励被发行，因为在以太坊中已经奖励过了)</p>
<p><img src="https://github.com/darwinia-network/rfcs/raw/master/RFC/zh_CN/images/darwinia_deposit_migration_protocol.png" alt="Gringotss Deposit Migration Protocol" /></p>
</li>
</ul>
<h3><a class="header" href="#iv-跨链转账的普通发行和普通赎回协议" id="iv-跨链转账的普通发行和普通赎回协议">IV. 跨链转账的普通发行和普通赎回协议</a></h3>
<p>对于Darwinia 来说，不仅仅存在主网上线后的Token迁移需求，还存在将主网上原生的RING/KTON资产跨链到其他公链的需求。因此以太坊上的ERC-20 RING不仅可以通过迁移协议单向回到Darwinia，也可以继续保留在以太坊上面，而且Darwinia上的RING还可以通过跨链转接桥作为CBA发行到以太坊上面成为ERC-20 RING，这个过程将由普通发行和赎回协议完成，其协议流程和设计跟正常的Token跨链协议一样，没有太大区别。</p>
<h2><a class="header" href="#参考" id="参考">参考</a></h2>
<ol>
<li>XClaim, https://eprint.iacr.org/2018/643.pdf</li>
<li>FlyClient, https://eprint.iacr.org/2019/226.pdf</li>
</ol>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../rfcs/0013.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="../rfcs/0013.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        
        <!-- Livereload script (if served using the cli tool) -->
        <script type="text/javascript">
            var socket = new WebSocket("ws://localhost:3001");
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload(true); // force reload from server (not from cache)
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>
        

        

        
        
        
        <script type="text/javascript">
            window.playpen_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
